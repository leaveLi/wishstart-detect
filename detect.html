<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" />
    <title>梦启科技用户诊断工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            font-size: 12px;
            font-family: tahoma, arial, sans-serif;
            line-height: 1.5;
        }

        .info {
            background: #FFFBCC;
            border: 1px solid #FFEC19;
            color: #666;
            line-height: 2;
            margin-top: 12px;
            text-indent: 6px;
            font-size: 16px;
        }

        #page {
            width: 90%;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            border-bottom: 1px solid #ccc;
            padding: 20px 0;
        }

        h3 {
            font-size: 20px;
            margin: 20px 0 4px;
        }

        h3 span {
            color: #06c !important;
        }

        #light-dialog,
        #light-dialog-shadow,
        #light-load {
            display: none;
        }
    </style>

    <script type="text/javascript">var JS_VERSION = 1.0;</script>
    <script language="Javascript1.1">var JS_VERSION = 1.1;</script>
    <script language="Javascript1.2">var JS_VERSION = 1.2;</script>
    <script language="Javascript1.3">var JS_VERSION = 1.3;</script>
    <script language="Javascript1.4">var JS_VERSION = 1.4;</script>
    <script language="Javascript1.5">var JS_VERSION = 1.5;</script>
    <script language="Javascript1.6">var JS_VERSION = 1.6;</script>
    <script language="Javascript1.7">var JS_VERSION = 1.7;</script>
    <script language="Javascript1.8">var JS_VERSION = 1.8;</script>
    <script language="Javascript1.9">var JS_VERSION = 1.9;</script>
</head>

<body>
    <div id="page">

        <h1>梦启科技用户诊断工具</h1>

        <div class="info">
            此页面仅用于定位您的浏览器和网络信息，不涉及您的隐私信息，请放心使用。
        </div>

        <noscript>
            <div>
                JavaScript 状态: 禁用。请开启后刷新重试。
            </div>
        </noscript>

        <div id="log">
        </div>

    </div>
    <script>
        var WSConfig = [
            // { url: 'laoyoutest.bflyzx.com', port: 10415 },
            { url: 'distgateway.bflyzx.com', port: 443 }
        ]
    </script>

    <script>/* Copyright (c) 2010-2012 Marcus Westin */
        this.JSON || (this.JSON = {}), function () { function f(e) { return e < 10 ? "0" + e : e } function quote(e) { return escapable.lastIndex = 0, escapable.test(e) ? '"' + e.replace(escapable, function (e) { var t = meta[e]; return typeof t == "string" ? t : "\\u" + ("0000" + e.charCodeAt(0).toString(16)).slice(-4) }) + '"' : '"' + e + '"' } function str(e, t) { var n, r, i, s, o = gap, u, a = t[e]; a && typeof a == "object" && typeof a.toJSON == "function" && (a = a.toJSON(e)), typeof rep == "function" && (a = rep.call(t, e, a)); switch (typeof a) { case "string": return quote(a); case "number": return isFinite(a) ? String(a) : "null"; case "boolean": case "null": return String(a); case "object": if (!a) return "null"; gap += indent, u = []; if (Object.prototype.toString.apply(a) === "[object Array]") { s = a.length; for (n = 0; n < s; n += 1)u[n] = str(n, a) || "null"; return i = u.length === 0 ? "[]" : gap ? "[\n" + gap + u.join(",\n" + gap) + "\n" + o + "]" : "[" + u.join(",") + "]", gap = o, i } if (rep && typeof rep == "object") { s = rep.length; for (n = 0; n < s; n += 1)r = rep[n], typeof r == "string" && (i = str(r, a), i && u.push(quote(r) + (gap ? ": " : ":") + i)) } else for (r in a) Object.hasOwnProperty.call(a, r) && (i = str(r, a), i && u.push(quote(r) + (gap ? ": " : ":") + i)); return i = u.length === 0 ? "{}" : gap ? "{\n" + gap + u.join(",\n" + gap) + "\n" + o + "}" : "{" + u.join(",") + "}", gap = o, i } } typeof Date.prototype.toJSON != "function" && (Date.prototype.toJSON = function (e) { return isFinite(this.valueOf()) ? this.getUTCFullYear() + "-" + f(this.getUTCMonth() + 1) + "-" + f(this.getUTCDate()) + "T" + f(this.getUTCHours()) + ":" + f(this.getUTCMinutes()) + ":" + f(this.getUTCSeconds()) + "Z" : null }, String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function (e) { return this.valueOf() }); var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, gap, indent, meta = { "\b": "\\b", " ": "\\t", "\n": "\\n", "\f": "\\f", "\r": "\\r", '"': '\\"', "\\": "\\\\" }, rep; typeof JSON.stringify != "function" && (JSON.stringify = function (e, t, n) { var r; gap = "", indent = ""; if (typeof n == "number") for (r = 0; r < n; r += 1)indent += " "; else typeof n == "string" && (indent = n); rep = t; if (!t || typeof t == "function" || typeof t == "object" && typeof t.length == "number") return str("", { "": e }); throw new Error("JSON.stringify") }), typeof JSON.parse != "function" && (JSON.parse = function (text, reviver) { function walk(e, t) { var n, r, i = e[t]; if (i && typeof i == "object") for (n in i) Object.hasOwnProperty.call(i, n) && (r = walk(i, n), r !== undefined ? i[n] = r : delete i[n]); return reviver.call(e, t, i) } var j; text = String(text), cx.lastIndex = 0, cx.test(text) && (text = text.replace(cx, function (e) { return "\\u" + ("0000" + e.charCodeAt(0).toString(16)).slice(-4) })); if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, "@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, "]").replace(/(?:^|:|,)(?:\s*\[)+/g, ""))) return j = eval("(" + text + ")"), typeof reviver == "function" ? walk({ "": j }, "") : j; throw new SyntaxError("JSON.parse") }) }(), function () { function o() { try { return r in t && t[r] } catch (e) { return !1 } } var e = {}, t = window, n = t.document, r = "localStorage", i = "__storejs__", s; e.disabled = !1, e.set = function (e, t) { }, e.get = function (e) { }, e.remove = function (e) { }, e.clear = function () { }, e.transact = function (t, n, r) { var i = e.get(t); r == null && (r = n, n = null), typeof i == "undefined" && (i = n || {}), r(i), e.set(t, i) }, e.getAll = function () { }, e.serialize = function (e) { return JSON.stringify(e) }, e.deserialize = function (e) { if (typeof e != "string") return undefined; try { return JSON.parse(e) } catch (t) { return e || undefined } }; if (o()) s = t[r], e.set = function (t, n) { return n === undefined ? e.remove(t) : (s.setItem(t, e.serialize(n)), n) }, e.get = function (t) { return e.deserialize(s.getItem(t)) }, e.remove = function (e) { s.removeItem(e) }, e.clear = function () { s.clear() }, e.getAll = function () { var t = {}; for (var n = 0; n < s.length; ++n) { var r = s.key(n); t[r] = e.get(r) } return t }; else if (n.documentElement.addBehavior) { var u, a; try { a = new ActiveXObject("htmlfile"), a.open(), a.write('<script>document.w=window<' + '/script><iframe src="/favicon.ico"></iframe>'), a.close(), u = a.w.frames[0].document, s = u.createElement("div") } catch (f) { s = n.createElement("div"), u = n.body } function l(t) { return function () { var n = Array.prototype.slice.call(arguments, 0); n.unshift(s), u.appendChild(s), s.addBehavior("#default#userData"), s.load(r); var i = t.apply(e, n); return u.removeChild(s), i } } var c = new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]", "g"); function h(e) { return e.replace(c, "___") } e.set = l(function (t, n, i) { return n = h(n), i === undefined ? e.remove(n) : (t.setAttribute(n, e.serialize(i)), t.save(r), i) }), e.get = l(function (t, n) { return n = h(n), e.deserialize(t.getAttribute(n)) }), e.remove = l(function (e, t) { t = h(t), e.removeAttribute(t), e.save(r) }), e.clear = l(function (e) { var t = e.XMLDocument.documentElement.attributes; e.load(r); for (var n = 0, i; i = t[n]; n++)e.removeAttribute(i.name); e.save(r) }), e.getAll = l(function (t) { var n = t.XMLDocument.documentElement.attributes, r = {}; for (var i = 0, s; s = n[i]; ++i) { var o = h(s.name); r[s.name] = e.deserialize(t.getAttribute(o)) } return r }) } try { e.set(i, i), e.get(i) != i && (e.disabled = !0), e.remove(i) } catch (f) { e.disabled = !0 } e.enabled = !e.disabled, typeof module != "undefined" && module.exports ? module.exports = e : typeof define == "function" && define.amd ? define(e) : this.store = e }()
    </script>

    <script>
            (function (w, d) {
                function appendChild(text1, text2, config) {
                    var el = d.querySelector('#log');
                    if (config) {
                        var tagName = config.tagName || 'div';
                        var wrapperEl = d.createElement(tagName);
                        var span1 = d.createElement('span');
                        span1.innerText = text1;
                        wrapperEl.appendChild(span1);
                        el.appendChild(wrapperEl);
                    }
                    else {
                        if (!text2 || typeof text2 == 'string') {
                            text2 = {
                                text: text2
                            }
                        }
                        var div = d.createElement('div');
                        var span1 = d.createElement('span');
                        span1.innerText = text1;
                        span1.style.color = '#666';
                        var span2 = d.createElement('span');
                        span2.innerText = text2.text || '';
                        span2.id = text2.id;
                        span2.style.fontSize = span1.style.fontSize = '16px';
                        div.appendChild(span1);
                        div.appendChild(span2);
                        el.appendChild(div);
                    }
                }

                function getBrowserInfo() {
                    var item, token, ua, _i, _len;

                    ua = navigator.userAgent;
                    token = ["Opera", "Chrome", "Safari", "MSIE 6", "MSIE 7", "MSIE 8", "Firefox"];
                    for (_i = 0, _len = token.length; _i < _len; _i++) {
                        item = token[_i];
                        if (ua.indexOf(item) > -1) {
                            return item.replace(" ", "");
                        }
                    }
                    return "Other";
                }

                function guid() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                function getCookieEnable() {
                    return document.cookie || navigator.cookieEnabled;
                };

                function jsonp(url, cb) {
                    var time = Date.now();
                    var callbackFunction = 'jsonp_callback_' + time;
                    w[callbackFunction] = function (data) {
                        s.parentNode.removeChild(s);
                        cb(data);
                    }
                    var s = d.createElement('script');
                    s.async = true;
                    s.src = url + '?' + 'cb=' + callbackFunction + '& _=' + time;
                    d.body.appendChild(s);
                }

                function getLDNS(cb) {
                    var uuid = guid();
                    var url = "https://" + uuid + ".dns-detect.alicdn.com/api/detect/DescribeDNSLookup"
                    return jsonp(url, cb);
                };

                function updateLocalIPANdLDns(ldns, localIp) {
                    var el = d.querySelector('#localDNS');
                    el.innerText = ldns;
                    el = d.querySelector('#localIP');
                    el.innerText = localIp;
                }

                function connectWS(urls) {
                    var info = urls.shift();
                    if (!info) return;
                    var url = info.url;
                    var port = info.port;
                    appendChild('开始连接: ', url);
                    var ws = new w.WebSocket('wss://' + url + ':' + port);
                    ws.binaryType = 'arraybuffer';
                    var time, onerror = false, times = [], heartbeatId = 0, heartbeatTimeoutId = 0;
                    function send() {
                        time = Date.now();
                        var arraybuffer = new w.ArrayBuffer(1);
                        var unit8 = new w.Uint8Array(arraybuffer);
                        unit8[0] = 1;
                        ws.send(arraybuffer);
                    }

                    function heartbeat() {
                        if (heartbeatTimeoutId) {
                            clearTimeout(heartbeatTimeoutId);
                            heartbeatTimeoutId = 0;
                        }

                        if (heartbeatId) return;

                        heartbeatId = setTimeout(function () {
                            heartbeatId = 0;
                            send();
                            heartbeatTimeoutId = setTimeout(function () {
                                heartbeatTimeoutId = 0;
                                if (times.length >= 10) return;
                                ws.onclose();
                            }, 5 * 1000);
                        }, 500);
                    }

                    ws.onopen = function () {
                        appendChild('连接成功!!');
                        send();
                    }
                    ws.onmessage = function (evt) {
                        time = Date.now() - time;
                        times.push(time);
                        appendChild('ping ' + url + ' ', time + 'ms');
                        heartbeat();
                    }
                    ws.onclose = function (evt) {
                        if (onerror) return;
                        if (times.length < 10) {
                            appendChild('超时，连接断开');
                            return;
                        }
                        appendChild('测试完成!!');
                        var avgTime = times.reduce(function (total, next) { return total + next }) / times.length;
                        var msg = '网络较差';
                        if (avgTime <= 100) msg = '网络较好'
                        if (avgTime <= 500 && avgTime > 100) msg = '网络一般';
                        appendChild('平均延迟: ', avgTime + 'ms' + '       ' + msg);
                        connectWS(urls);
                    }

                    ws.onerror = function (evt) {
                        onerror = true;
                        appendChild('网络异常，连接失败');
                    }
                }

                appendChild("基础信息: ", '', {
                    "tagName": "h3"
                });

                appendChild('用户信息: ', navigator.userAgent)

                appendChild('浏览器信息: ', getBrowserInfo());

                appendChild('Cookie 状态: ', getCookieEnable() ? '开启' : '禁用')

                appendChild('JavaScript 状态: ', '开启 (版本号：' + JS_VERSION + ')')

                appendChild("LocalStorage 状态: ", store.enabled ? '开启' : '禁用');

                appendChild("网络信息: ", '', {
                    "tagName": "h3"
                });

                appendChild("Local DNS: ", { id: 'localDNS' });
                appendChild("本地IP: ", { id: 'localIP' });

                getLDNS(function (data) {
                    if (data.retCode == 200) {
                        updateLocalIPANdLDns(data.content.ldns, data.content.localIp)
                    }
                });

                appendChild("正在准备测试环境: ", '', { tagName: 'h3' });

                connectWS(WSConfig);

            }(window, document));
    </script>
</body>

</html>